#!/usr/bin/env ruby
require 'coolline'
require 'fileutils'


def split_ext(filename)
  filename.split /(\.[^\.]+)$/
end

def restore_spaces(s)
  s.gsub(/(?<=\S)(_|\.)(?=\S)/, ' ')
end

def titlecase(str)
  str.downcase.gsub(/\b\w/) { |m| m.upcase }
end

def edit_filename(prompt, filename)

  Coolline.new do |c|

    c.word_boundaries = [" ", "\t", ".", ",", ";", '"', "'", "`", "<", ">",
                         "=", ";", "|", "{", "}", "(", ")", "-", "/"]

    # Alt-u capitalizes everything
    c.bind "\eu" do |inst|
      base, ext = split_ext inst.line
      pos       = inst.pos
      
      inst.line = titlecase(base) + ext
      inst.pos  = pos
    end

    # ^u removes underscores and stuff
    c.bind "\x15" do |inst|
      base, ext = split_ext inst.line
      pos       = inst.pos
      
      inst.line = restore_spaces(base) + (ext || "")
      inst.pos  = pos
    end

    # ^d deletes to the extension
    c.bind "\x04" do |inst|
      start  = inst.pos
      finish = inst.line.rindex(".")

      inst.line[start...finish] = "" if start < finish
    end
  end.readline(prompt, filename)

end

def STDIN.purge
  loop { read_nonblock(4096) } rescue nil
end


if __FILE__ == $0

  puts
  puts "#{ARGV.size} thing(s) to rename..."
  puts

  for arg in ARGV
    unless File.exists? arg
      puts "Error: #{arg.inspect} not found..."
      next
    end

    puts "Rename: #{arg}"

    new_filename = edit_filename("    to: ", arg)

    puts

    if arg == new_filename
      puts "Skipping..."
      puts
      next
    end

    if File.exists? new_filename
      STDIN.purge
      print "#{new_filename} exists. Overwrite? (y/N) "
      case gets.strip.downcase
      when "y"
        puts "Clobbering..."
      else
        puts "Skipping..."
        next
      end
    end

    puts "Renaming #{arg.inspect} to #{new_filename.inspect}"
    FileUtils.mv arg, File.expand_path(new_filename)
    puts
  end

end
