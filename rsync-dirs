#!/usr/bin/env ruby

opts, args = ARGV.partition { |arg| arg =~ /^-/ }
opts.uniq!

if args.any?

  letters = %w[r l t z]
  params  = []

  unless opts.delete "-q"
    params  << "--progress"        
    letters << "v"
  end

  params << "--bwlimit=40"      if opts.delete "-l"  # limit bandwidth
  params << "--append"          if opts.delete "-a"  # append to smaller remote files
  params << "--append-verify"   if opts.delete "-k"  # keep larger remote files
  params << "--partial"         if opts.delete "-p"  # partials
  params << "--delete-after"    if opts.delete "-d"  # delete destination files
  
  if opts.delete "-b" # binary mode
    params += ["--checksum", "--copy-links"]
  else
    params << "--size-only"
  end

  params += opts
  params += args

  cmd = ["rsync", "-#{letters.join ''}"] + params

  puts "Executing:"
  puts "\t#{cmd.join ' '}"
  puts
  system *cmd
  
else
  
  puts "usage: rsync-dirs [options] <src> <dest>"
  puts
  puts "Special options:"
  puts "    -q    Quiet mode"
  puts "    -b    Binary rsync (and dereference symlinks)"
  puts "    -a    Append to smaller remote files"
  puts "    -k    Keep larger remote files"
  puts "          (and their overlap has the same checksum)"
  puts "    -d    Delete destination files that aren't in the source"
  puts "    -p    Keep partially-transferred files"
  puts "    -l    Limit bandwidth to 40k/sec"
  puts
  
end
